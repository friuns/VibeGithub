name: Setup Repository
# This workflow automates repository setup by:
# - Creating a React + Vite project template
# - Copying all workflows from the reference repository (friuns/VibeGithub)
# - Configuring GitHub Pages with GitHub Actions as the build source
# - Setting the repository website URL to the GitHub Pages URL
# - Committing and pushing all changes

on:
  workflow_dispatch:
    inputs:
      template:
        description: 'Vite template to use'
        required: false
        default: 'react-ts'
        type: choice
        options:
          - react-ts
          - react
          - react-swc-ts
          - react-swc
          - vue-ts
          - vue
          - preact-ts
          - preact
          - lit-ts
          - lit
          - svelte-ts
          - svelte
          - solid-ts
          - solid
          - qwik-ts
          - qwik
          - vanilla-ts
          - vanilla

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.OAUTH_TOKEN || github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create Vite project template
        env:
          TEMPLATE: ${{ inputs.template || 'react-ts' }}
        run: |
          echo "âš›ï¸  Creating Vite project with template: $TEMPLATE"
          
          # Check if this is an empty repository
          if [ -z "$(ls -A)" ] || [ ! -f "package.json" ]; then
            echo "Creating new Vite project with $TEMPLATE template..."
            
            # Create project using npm create vite
            npm create vite@latest . -- --template $TEMPLATE
            
            # Install dependencies
            npm install
            
            echo "âœ… Vite project created with $TEMPLATE template!"
          else
            echo "Repository already has files, skipping template creation"
          fi

      - name: Copy workflows from reference repository
        env:
          GH_TOKEN: ${{ secrets.OAUTH_TOKEN || github.token }}
          REFERENCE_REPO: friuns/VibeGithub
        run: |
          echo "ðŸ“¥ Copying workflows from $REFERENCE_REPO..."
          
          # Create workflows directory if it doesn't exist
          mkdir -p .github/workflows
          
          # Get list of workflow files from reference repository
          WORKFLOWS=$(gh api repos/$REFERENCE_REPO/contents/.github/workflows \
            --jq '.[] | select(.name | endswith(".yml") or endswith(".yaml")) | select(.name != "setup.yml") | .name')
          
          echo "Found workflows:"
          echo "$WORKFLOWS"
          
          # Copy each workflow file
          for workflow in $WORKFLOWS; do
            echo "Copying $workflow..."
            gh api repos/$REFERENCE_REPO/contents/.github/workflows/$workflow \
              --jq '.content' | base64 -d > .github/workflows/$workflow
          done
          
          echo "âœ… Workflows copied successfully!"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Create commit message
            COMMIT_MSG="Initialize repository with React + Vite template

            - Created React + TypeScript project with Vite
            - Added workflows from friuns/VibeGithub"
            
            if [ -d ".github/workflows" ]; then
              COMMIT_MSG="$COMMIT_MSG
            
            Workflows installed:
            $(ls -1 .github/workflows/ | grep -v setup.yml | sed 's/^/- /')"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… Changes committed and pushed!"
          fi

      - name: Enable GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.OAUTH_TOKEN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸ“„ Configuring GitHub Pages..."
          
          # Try to create Pages with GitHub Actions as the source
          RESPONSE=$(gh api -X POST repos/$REPO/pages \
            -f build_type=workflow \
            2>&1 || echo "CREATE_FAILED")
          
          if [[ "$RESPONSE" == *"CREATE_FAILED"* ]] || [[ "$RESPONSE" == *"already exists"* ]]; then
            echo "Pages may already exist, attempting to update..."
            gh api -X PUT repos/$REPO/pages \
              -f build_type=workflow \
              2>&1 || echo "âš ï¸ Could not update Pages (may need manual configuration)"
          fi
          
          echo "âœ… GitHub Pages configured with GitHub Actions as the source!"

      - name: Set repository website to GitHub Pages URL
        env:
          GH_TOKEN: ${{ secrets.OAUTH_TOKEN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸŒ Setting repository website URL..."
          
          # Extract owner and repo name
          OWNER=$(echo $REPO | cut -d'/' -f1)
          REPO_NAME=$(echo $REPO | cut -d'/' -f2)
          
          # Construct GitHub Pages URL
          PAGES_URL="https://${OWNER}.github.io/${REPO_NAME}"
          
          # Update repository with homepage URL
          gh api -X PATCH repos/$REPO \
            -f homepage="$PAGES_URL" \
            2>&1 || echo "âš ï¸ Could not set homepage URL"
          
          echo "âœ… Repository website set to: $PAGES_URL"

      - name: Setup Summary
        run: |
          echo "## ðŸŽ‰ Repository Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Created React + TypeScript project with Vite" >> $GITHUB_STEP_SUMMARY
          echo "- Copied workflows from friuns/VibeGithub" >> $GITHUB_STEP_SUMMARY
          echo "- Configured GitHub Pages with GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Set repository website to GitHub Pages URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš›ï¸  Project Stack:" >> $GITHUB_STEP_SUMMARY
          echo "- **Framework**: React 18 with TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Tool**: Vite" >> $GITHUB_STEP_SUMMARY
          echo "- **Development**: Hot Module Replacement (HMR)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Workflows Installed:" >> $GITHUB_STEP_SUMMARY
          if [ -d ".github/workflows" ]; then
            ls -1 .github/workflows/ | grep -v setup.yml | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Getting Started:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git clone https://github.com/${{ github.repository }}.git" >> $GITHUB_STEP_SUMMARY
          echo "cd $(echo "${{ github.repository }}" | cut -d'/' -f2)" >> $GITHUB_STEP_SUMMARY
          echo "npm install" >> $GITHUB_STEP_SUMMARY
          echo "npm run dev" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
          
          # Extract owner and repo for Pages URL
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          PAGES_URL="https://${OWNER}.github.io/${REPO_NAME}"
          
          echo "- [GitHub Pages Site]($PAGES_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages Settings](https://github.com/${{ github.repository }}/settings/pages)" >> $GITHUB_STEP_SUMMARY
          echo "- [Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflows](https://github.com/${{ github.repository }}/tree/main/.github/workflows)" >> $GITHUB_STEP_SUMMARY


