name: "Comment on PR on Workflow Failure"

on:
  workflow_run:
    workflows: ["*"]  # Monitor all workflows
    types:
      - completed

permissions:
  actions: read
  checks: read
  contents: read
  pull-requests: write
  issues: write

jobs:
  comment-on-failure:
    runs-on: ubuntu-latest
    # Trigger on failure from push or pull_request events (push to PR branch also counts)
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Comment on PR with failure details
        uses: actions/github-script@v7
        with:
          # Use a Personal Access Token (PAT) to post comments as the repository owner
          # instead of github-actions[bot]. You need to:
          # 1. Create a PAT at: https://github.com/settings/tokens (Fine-grained or Classic)
          #    - For Classic PAT: Select 'repo' scope
          #    - For Fine-grained PAT: Select 'Pull requests' and 'Issues' with read/write access
          # 2. Add it as a repository secret named 'PAT_TOKEN' at:
          #    Settings > Secrets and variables > Actions > New repository secret
          github-token: ${{ secrets.OAUTH_TOKEN }}
          script: |
            // Use the workflow run data from the event payload
            const workflowRun = context.payload.workflow_run;
            
            console.log(`Processing failed workflow: ${workflowRun.name}`);
            console.log(`Workflow run ID: ${workflowRun.id}`);
            console.log(`Head SHA: ${workflowRun.head_sha}`);

            // Get the jobs for this workflow run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflowRun.id,
              filter: 'latest'
            });

            // Find failed jobs
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // Get the PR that triggered this workflow
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: workflowRun.head_sha
            });

            if (pullRequests.data.length === 0) {
              console.log('No pull request found for this commit');
              return;
            }

            const pr = pullRequests.data[0];

            // Fetch logs for failed jobs
            const jobLogs = {};
            for (const job of failedJobs) {
              try {
                const logsResponse = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                
                // The response is the log content as a string
                let logs = logsResponse.data;
                
                // Extract last 100 lines to keep comment size manageable
                const lines = logs.split('\n');
                const maxLines = 100;
                if (lines.length > maxLines) {
                  logs = `... (truncated ${lines.length - maxLines} lines)\n\n` + lines.slice(-maxLines).join('\n');
                }
                
                jobLogs[job.id] = logs;
              } catch (error) {
                console.log(`Failed to fetch logs for job ${job.name}: ${error.message}`);
                jobLogs[job.id] = 'Unable to fetch logs: '+error.message;
              }
            }

            // Build the comment body
            let commentBody = `@jules\n\n`;
            commentBody += `## âŒ Workflow Failed\n\n`;
            commentBody += `**Workflow:** ${workflowRun.name}\n`;
            commentBody += `**Run:** #${workflowRun.run_number}\n`;
            commentBody += `**Commit:** ${workflowRun.head_sha.substring(0, 7)}\n`;
            commentBody += `**Triggered by:** @${workflowRun.triggering_actor.login}\n\n`;

            if (failedJobs.length > 0) {
              for (const job of failedJobs) {
                commentBody += `### âŒ ${job.name}\n\n`;
                
                if (job.steps) {
                  const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
                  if (failedSteps.length > 0) {
                    commentBody += `**Failed Steps:** ${failedSteps.map(s => s.name).join(', ')}\n\n`;
                  }
                }
                
                // Add the logs in a collapsible section
                commentBody += `<details>\n<summary>ðŸ“‹ View Logs</summary>\n\n`;
                commentBody += `\`\`\`\n${jobLogs[job.id] || 'No logs available'}\n\`\`\`\n`;
                commentBody += `</details>\n\n`;
              }
            }

            commentBody += `---\n`;
            commentBody += `*ðŸ¤– This comment was automatically generated by GitHub Actions*`;

            // Check if we already commented on this PR for this workflow run
            const existingComments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const alreadyCommented = existingComments.data.some(comment =>
              comment.body && 
              comment.body.includes(`Workflow Failed`) &&
              comment.body.includes(`Run: [#${workflowRun.run_number}]`)
            );

            const totalComments = existingComments.data.length;

            if (!alreadyCommented && totalComments < 10) {
              // Post the comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody
              });

              console.log(`âœ… Posted failure comment on PR #${pr.number}`);
            } else if (alreadyCommented) {
              console.log(`â„¹ï¸ Already commented on PR #${pr.number} for this workflow run`);
            } else if (totalComments >= 3) {
              console.log(`â„¹ï¸ Skipping comment on PR #${pr.number} - PR already has ${totalComments} comments (>= 10)`);
            }
